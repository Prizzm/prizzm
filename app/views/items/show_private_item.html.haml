- content_for :page_style do
  = include_stylesheets :wysiwyg
  = include_stylesheets :item_detail

#content.grid_14
  %section#review    
    .revpost
      = link_to "Edit Item", '#', :class => "edit-cntrl", :id => "edit-review-link"
      
      .title= raw format h @item.name
      .clear
      .fl.galsect
        = render 'images'
      #rendered-review.fl
        #options
        - if @item.review.blank?
          = render 'default_review'
        - else
          = raw sanitize @item.review, :tags => %w(p b i u strike ul ol li blockquote), :attributes => %w(id class style)
    .clear

    #review_status
    = form_for [current_user, @item], :remote => true, :method => 'PUT' do |f|
      = f.text_field :tag_list, :placeholder => "+ Add Tags"
    #footerbit
      .fl
        Written #{@item.created_at.to_date} - Edited #{time_ago_in_words @item.updated_at} ago
        \| Comments 
        = @item.comment_threads.count
      %div{ :class => "status #{@item.privacy if @item.is_private?}" }= @item.privacy
      .clear
    .clear
     
  = comments_section_for @item

%aside.grid_6
  %article
    %h4 Your opinion
    = form_tag item_save_opinion_path, :remote => true do
      = select_tag :opinion, options_for_select(Item::OPINION.map { |o| [o.humanize, Item::OPINION.index(o)] }, Item::OPINION.index(@item.opinion)), :class => "sel_opinion"
      .loading{:style => "display:none;float:left"}
      .clear
      = hidden_field_tag :id, @item.id
    .clear
  %article
    %h4 Share it
    = form_tag item_post_to_facebook_path(@item), :remote => true, :class => "table", :id => "form-ask-friend" do
      = text_field_tag :message, "", :placeholder => "Message"
      %ul.finalstep.buttons.fr
        %li.fb{:title => "post to facebook"}
          / facebook checkbox goes here
        %li.tt
          / twitter checkbox goes here
        %li.privacy
          / privacy drop down goes here
        %li
          = hidden_field_tag :link, item_url(@item)
          = link_to "Share", "#", :id => 'button-ask-friend', :class => "button green"
          .loading{:style => "display:none;float:left"}
      .clear
  %article= link_to "open case", "#", :class => "button"
.clear

- content_for :javascripts do
  = include_javascripts :wysiwyg
  = include_javascripts :item_detail

  :javascript
    $(document).ready(function() {
      #{render 'tags/taggable.js.erb', :taggable => @item} 

      var editor;

      // For commment loading animation.
      $('.new_comment').live('ajax:beforeSend', function() {
        var cmt = $(this).find('textarea');
        if ($(cmt).val().trim().length == 0) {
          alert("Comment can't be empty");
          return false;
        };

        $(this).find('.loading').show();
      });

      $('.new_comment').live('ajax:complete', function() {
        $(this).find('.loading').hide();
      });
      // End loading animation.

      $('#edit-review-link').click(function(){
        $.facebox(function(){
          $.get('#{edit_item_path}', function(html){
            $.facebox(html);

            $('#facebox').find('textarea').wysiwyg({
              controls: {
                bold: { visible: true },
                italic: { visible: true },
                underline: { visible: true },
                strikeThrough: { visible: true },

                justifyLeft: { visible: true },
                justifyCenter: { visible: true },
                justifyRight: { visible: true },
                justifyFull: { visible: true },

                undo: { visible: true },
                redo: { visible: true },

                insertOrderedList: { visible: true },
                insertUnorderedList: { visible: true },

                createLink: { visible: true },
                insertImage: { visible: true },

                paragraph: { visible: true },
              },
              rmUnusedControls: true
            });

            $('#facebox').find('.cancel-edit').click(function(){
              $(document).trigger('close.facebox');
            });
          }, 'html');
        });
      });


      $('form.edit_item').live('ajax:success', function(event, data, status, xhr){
        $(document).trigger('close.facebox');
      });
    });
