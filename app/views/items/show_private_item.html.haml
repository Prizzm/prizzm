- content_for :page_style do
  = include_stylesheets :item_detail

%header
  %h2
    -# = link_to "Add Company", new_company_path, :class => 'tag company'
    -# = text_field_tag "company_name", "", :class => "jq_watermark", :title => "Add Company"
    = @item.name

%aside.grid_5
  %article
    = render 'images'

    = fields_for ItemImage.new do |f|
      = f.file_field :image, :rel => item_images_path(@item)                        
    = photo_uploadify

    %br
    = link_to @item.url, @item.url

    = form_tag item_images_path(@item), :remote => true, :multipart => true, :id => "add-remote-image" do
      = fields_for :image do |builder|
        = builder.text_field :remote_image_url, :id => "graburl", :placeholder => "Add a URL"
        %div{:style => "display:none"}
          = builder.submit
    .loading{:style => "display:none"}

    
#content.grid_13
  %section#review
    = link_to "Edit review", '#', :class => "edit-cntrl", :id => "edit-review-link"
    .title Review
    #rendered-review
      - if @item.review.blank?
        = render 'default_review'
      - else
        = raw @item.review
    #review-editor
      = form_for @item, :remote => true, :method => :put do |f|
        = f.text_area :review
        = f.submit 'Save'
    #review_status 
  .title Company
  #company
    = render "company", :company => @item.company
  %br
  = comments_section_for @item
%aside.grid_6
  %article
    %h4 What do you think about the product?
    %select
      %option No opinion
      %option I recommend this!
      %option Horrible!
  %article
    %h4 Publish
    .table
      .row
        .cell.left Visibility:
        .cell.right
          = privacy_control_for @item
      - if @item.is_public?
        .row
          .cell.left Share link:
          .cell.right
            %input{:type => "text", :value => item_url(@item)}/
  %article
    %h4 Ask your friends for advice
    %form.table
      .row
        .cell
          %input{:type => "text"}/
      .row
        .cell.left Ask your
        .cell.right
          %ul.sharebts
            %li.sharebt.fb
              facebook
              .close
            %li.sharebt.twitter
              twitter
              .close
      %a.button.fr{:href => ""} Ask
  %article
    %h4 Feeds
    Reserved for a feed of other people's reviews.
.clear

- content_for :javascripts do
  = javascript_include_tag 'ckeditor/ckeditor.js'

  :javascript

    $(document).ready(function() {
      var editor;

      // For commment loading animation.
      $('.new_comment').live('ajax:beforeSend', function() {
        var cmt = $(this).find('textarea');
        if ($(cmt).val().trim().length == 0) {
          alert("Comment can't be empty");
          return false;
        };

        $(this).find('.loading').show();
      });

      $('.new_comment').live('ajax:complete', function() {
        $(this).find('.loading').hide();
      });
      // End loading animation.

      function showEditor(){
        editor = CKEDITOR.replace('item_review',{
          customConfig: '/javascripts/ckeditor_custom/item_review_config.js' 
        });
      }

      $('#edit-review-link').click(function(){
        showEditor();
        $('#rendered-review').hide();
        $('#review-editor').show();
      });


      $('form.edit_item').live('ajax:success', function(event, data, status, xhr){
        var editor_data = CKEDITOR.instances.item_review.getData();
        $('#rendered-review').html(editor_data);
        $('#rendered-review').show();
        $('form.edit_item textarea').val(editor_data);
        $('#review-editor').hide();
        editor.destroy();
      });


      var update_item_company = function(company_id){

        $.ajax({
          type : 'PUT',
          url: '#{update_item_company_path}',
          data : {company_id : company_id},
          dataType: "script",
          success: function(r){
            // success
          }
        });

      };

      $('#add-remote-image').bind('submit', function() {
        $('.loading', 'aside').show();
      });
      $('#add-remote-image').bind('ajax:complete', function(e, xhr, settings) {
        $('.loading', 'aside').hide();
        $('#graburl').val('');
        $('body').trigger('insertImage', xhr.responseText);
      });

      $("#company_name").autocomplete({
        source: function(request, response) {
          $.ajax({
            url: '#{search_companies_path}',
            data : {query:request.term},
            dataType: "json",
            success: function(r){

              if (r.length <= 0){
                response([{label : "Not Found - Add '" + request.term + "'", value : request.term,  add_new_company : true }]);
                return;
              }
              else
              {
                var resp_data = $.map(r, function(elem, i){
                  return $.extend({label:elem.name}, elem);
                });

                response(resp_data);
              }
            }
          });
        },
        select : function(event, ui){
          if ( ui.item.add_new_company ){
            $("input#company_name").val("");
            $.facebox({ ajax : "/companies/new?company_name=" + encodeURIComponent(ui.item.value) });
            window.company_after_save_handler = function(company){
              alert("Now set it for Item");
              update_item_company(company.id);
            };
            $('#company_name').autocomplete("close");
            return false;
          }
          else
          {
            $("input#company_name").val("");
            update_item_company(ui.item.id);
            $('#company_name').autocomplete("close");
            return false;
          }
          //event.preventDefault();
          //return false;
        },
        open : function(event, ui){

          $("#add_new_company").click(function(){
            //alert($(this).parents("li.li_company_autocomplete").data('item'));
            //return false;
          });

          $(".add_company_button").click(function(){
            //alert($(this).parents("li.li_company_autocomplete").data(''));
            //return false;
          });

          $(".company_select_link").click(function(){
            //alert("Wait");
            //return false;
          });
        }
      }).data( "autocomplete" )._renderItem = function( ul, item ) {
        var main_li = $( "<li class='li_company_autocomplete' style=''></li>" ).data( "item", item );
        if ( item.add_new_company ){
          return main_li.append( "<a style='width:100%;height:100%;display:block;padding:0;' id='add_new_company' class='company_select_link' >" + "<span style=''>" + item.label + "</span>" + "</a>" ).appendTo( ul );
        }
        else{
          return main_li.append( "<a style='width:100%;height:100%;display:block;padding:0;' class='company_select_link' >" + "<span style=''>" + item.label + "</span>" + "</a>" ).appendTo( ul );
        }
        //return $( "<li class='li_company_autocomplete' style='height:22px;'></li>" ).data( "item.autocomplete", item ).append( "<a style='width:100%;height:100%;display:block;padding:0;' class='company_select_link' >" + "<button style='float:right;' class='add_company_button' >Add</button>" + "<span style='float:right;'>" + item.label + "</span>" + "</a>" ).appendTo( ul );
      };
      
    });
