- content_for :page_style do
  = include_stylesheets :item_detail

.clear

#content.grid_14
  %section#review
    .fl.galsect
      = render 'images'    
    .fl.revpost
      = privacy_control_for @item
      = link_to "Edit review", '#', :class => "edit-cntrl", :id => "edit-review-link"
      
      .title= raw format h @item.name
      #options
        = link_to @item.url, @item.url
      #rendered-review
        - if @item.review.blank?
          = render 'default_review'
        - else
          = raw format h @item.review
      #review-editor
        = form_for @item, :remote => true, :method => :put do |f|
          = f.text_area :review
          = f.submit 'Save'
    .clear
    
    #review_status
    = form_for [current_user, @item], :remote => true, :method => 'PUT' do |f|
      = f.text_field :tag_list, :placeholder => "+ Add Tags", :title => "+Add Tags", :class => "jq_watermark"
    #footerbit
      Written #{@item.created_at.to_date} - Edited #{time_ago_in_words @item.updated_at} ago |
      %a{:href => ""} #{pluralize @item.comment_threads.count, "Comment"}
    .clear
     
  = comments_section_for @item

%aside.grid_6
  %article
    %h4 Your opinion
    = form_tag item_save_opinion_path, :remote => true do
      = select_tag :opinion, options_for_select(Item::OPINION.map { |o| [o.humanize, Item::OPINION.index(o)] }, Item::OPINION.index(@item.opinion))
      = hidden_field_tag :id, @item.id
  %article
    %h4 Share
    = form_tag item_post_to_facebook_path(@item), :remote => true, :class => "table", :id => "form-ask-friend" do
      .row
        .cell
          = text_field_tag :message, "", :placeholder => "Message"
          = hidden_field_tag :link, item_url(@item)
      .row
        %ul.sharebts
          %li Share to
          %li.sharebt.fb.active
            facebook
            .close
          %li.sharebt.twitter
            twitter
            .close
      = link_to "Share", "#", :id => 'button-ask-friend', :class => "button green fr"
      .loading{:style => "display:none;float:left"}
  %article
    %h4 Feeds
    Reserved for a feed of other people's reviews.
.clear

- content_for :javascripts do
  = javascript_include_tag 'ckeditor/ckeditor.js'
  = javascript_include_tag 'application/item_detail.js'

  :javascript
    $(document).ready(function() {


      #{render 'tags/taggable.js.erb', :taggable => @item} 

      var editor;

      // For commment loading animation.
      $('.new_comment').live('ajax:beforeSend', function() {
        var cmt = $(this).find('textarea');
        if ($(cmt).val().trim().length == 0) {
          alert("Comment can't be empty");
          return false;
        };

        $(this).find('.loading').show();
      });

      $('.new_comment').live('ajax:complete', function() {
        $(this).find('.loading').hide();
      });
      // End loading animation.

      function showEditor(){
        editor = CKEDITOR.replace('item_review',{
          customConfig: '/javascripts/ckeditor_custom/item_review_config.js' 
        });
      }

      $('#edit-review-link').click(function(){
        showEditor();
        $('#rendered-review').hide();
        $('#review-editor').show();
      });


      $('form.edit_item').live('ajax:success', function(event, data, status, xhr){
        var editor_data = CKEDITOR.instances.item_review.getData();
        $('#rendered-review').html(editor_data);
        $('#rendered-review').show();
        $('form.edit_item textarea').val(editor_data);
        $('#review-editor').hide();
        editor.destroy();
      });

      $('#add-remote-image').bind('submit', function() {
        $('.loading', 'aside').show();
      });
      $('#add-remote-image').bind('ajax:complete', function(e, xhr, settings) {
        $('.loading', 'aside').hide();
        $('#graburl').val('');
        $('body').trigger('insertImage', xhr.responseText);
      });
    });
